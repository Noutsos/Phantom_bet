{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>Model Training</h2>
    <p>Configure and run model training</p>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <form method="POST" class="config-form">
        <div class="form-section">
            <h4>Basic Configuration</h4>
            
            <div class="form-group">
                <label for="target_col">Target Column:</label>
                <input type="text" id="target_col" name="target_col" value="outcome" required>
            </div>
            
            <div class="form-group">
                <label for="model_type">Model Type:</label>
                <select id="model_type" name="model_type">
                    <option value="xgboost">XGBoost</option>
                    <option value="random_forest">Random Forest</option>
                    <option value="logistic_regression">Logistic Regression</option>
                    <option value="svm">SVM</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="feature_selection_method">Feature Selection Method:</label>
                <select id="feature_selection_method" name="feature_selection_method">
                    <option value="rfe">RFE</option>
                    <option value="selectkbest">SelectKBest</option>
                    <option value="importance">Feature Importance</option>
                    <option value="none">None</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="top_n_features">Top N Features:</label>
                <input type="number" id="top_n_features" name="top_n_features" value="60" min="1" max="100">
            </div>
            
            <div class="form-group">
                <label for="holdout_ratio">Holdout Ratio:</label>
                <input type="number" id="holdout_ratio" name="holdout_ratio" step="0.01" min="0.1" max="0.5" value="0.2">
                <small class="form-text">Proportion of most recent data to use for testing (0.1-0.5)</small>
            </div>
        </div>

        <div class="form-section">
            <h4>Hyperparameter Tuning</h4>
            
            <div class="form-group">
                <label><input type="checkbox" name="use_bayesian"> Use Bayesian Optimization</label>
            </div>
            
            <div class="form-group">
                <label for="bayesian_iter">Bayesian Iterations:</label>
                <input type="number" id="bayesian_iter" name="bayesian_iter" value="50" min="10" max="200">
            </div>
            
            <div class="form-group">
                <label><input type="checkbox" name="use_grid_search"> Use Grid Search</label>
            </div>
            
            <div class="form-group">
                <label><input type="checkbox" name="use_random_search"> Use Random Search</label>
            </div>
            
            <div class="form-group">
                <label for="random_search_iter">Random Search Iterations:</label>
                <input type="number" id="random_search_iter" name="random_search_iter" value="50" min="10" max="200">
            </div>
            
            <div class="form-group">
                <label><input type="checkbox" name="load_params" checked> Load Best Parameters from Previous Runs</label>
            </div>
        </div>

            
        <div class="form-group">
            <label><input type="checkbox" name="handle_class_imbalance" checked> Handle Class Imbalance</label>
        </div>
        
        <div class="form-group">
            <label for="class_weight_type">Class Weight Method:</label>
            <select id="class_weight_type" name="class_weight_type">
                <option value="auto">Automatic Balanced Weights</option>
                <option value="football">Football Weights (2.5x Draws)</option>
                <option value="custom">Custom Weights</option>
                <option value="none">No Weights</option>
            </select>
        </div>
        
        <div class="form-group" id="custom_weights_group">
            <label for="custom_weights_dict">Custom Weights (JSON):</label>
            <input type="text" id="custom_weights_dict" name="custom_weights_dict" placeholder='{"0": 1.0, "1": 2.5, "2": 1.0}'>
            <small class="form-text">Weight values for each class</small>
        </div>
        
        <div class="form-group">
            <label><input type="checkbox" name="use_smote"> Use SMOTE Instead</label>
        </div>
        
        <div class="form-group" id="smote_strategy_group">
            <label for="smote_strategy">SMOTE Strategy:</label>
            <select id="smote_strategy" name="smote_strategy">
                <option value="draws_only">Only Oversample Draws</option>
                <option value="all_to_majority">Oversample All to Majority</option>
            </select>
        </div>
        
        <div class="form-group" id="smote_factor_group">
            <label for="smote_factor">Oversampling Factor:</label>
            <select id="smote_factor" name="smote_factor">
                <option value="0.8">80% of Majority</option>
                <option value="0.9">90% of Majority</option>
                <option value="1.0" selected>Balance to Majority</option>
                <option value="1.1">110% of Majority</option>
                <option value="1.2">120% of Majority</option>
            </select>
        </div>
            
            
        
        
        <button type="submit" class="btn btn-primary">Run Training</button>
    </form>
</div>

<script>
// Simple JavaScript to toggle form fields based on selections
document.addEventListener('DOMContentLoaded', function() {
    const handleImbalance = document.getElementById('handle_imbalance');
    const useSmote = document.getElementById('use_smote');
    const smoteGroup = document.getElementById('smote_group');
    const smoteStrategyGroup = document.getElementById('smote_strategy_group');
    const classWeightsGroup = document.getElementById('class_weights_group');
    
    function toggleImbalanceFields() {
        const imbalanceEnabled = handleImbalance.checked;
        smoteGroup.style.display = imbalanceEnabled ? 'block' : 'none';
        smoteStrategyGroup.style.display = (imbalanceEnabled && useSmote.checked) ? 'block' : 'none';
        classWeightsGroup.style.display = (imbalanceEnabled && !useSmote.checked) ? 'block' : 'none';
    }
    
    handleImbalance.addEventListener('change', toggleImbalanceFields);
    useSmote.addEventListener('change', toggleImbalanceFields);
    
    // Initial toggle
    toggleImbalanceFields();
});
</script>

<style>
.form-section {
    margin-bottom: 2rem;
    padding: 1rem;
    border: 1px solid #ddd;
    border-radius: 5px;
}
.form-section h4 {
    margin-top: 0;
    color: #007bff;
}
.form-text {
    color: #6c757d;
    font-size: 0.875rem;
}
</style>
{% endblock %}