{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>Data Collection</h2>
    <p>Configure and run data collection from soccer APIs</p>
    
    <form method="POST" class="config-form">
        <!-- Basic Configuration Fields (keep your existing ones) -->
        <div class="form-group">
            <label for="season">Season:</label>
            <input type="number" id="season" name="season" value="2024" required>
        </div>
        
        <div class="form-group">
            <label for="collection_phase">Collection Phase:</label>
            <select id="collection_phase" name="collection_phase">
                <option value="1">Phase 1 (Historical)</option>
                <option value="2">Phase 2 (Current)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Data Types:</label>
            <div class="checkbox-group">
                <label><input type="checkbox" name="data_types" value="fixture_events" checked> Fixture Events</label>
                <label><input type="checkbox" name="data_types" value="team_statistics" checked> Team Statistics</label>
                <label><input type="checkbox" name="data_types" value="team_standings"> Team Standings</label>
                <label><input type="checkbox" name="data_types" value="player_statistics"> Player Statistics</label>
                <label><input type="checkbox" name="data_types" value="injuries"> Injuries</label>
                <label><input type="checkbox" name="data_types" value="lineups"> Lineups</label>
                <label><input type="checkbox" name="data_types" value="odds"> Odds</label>
            </div>
        </div>

        <!-- Unified Selection Tree -->
        <div class="form-section">
            <h3>League Selection</h3>
            
            <!-- Search and Quick Actions -->
            <div class="row mb-3">
                <div class="col-md-8">
                    <input type="text" id="unifiedSearch" placeholder="Search regions, countries, or leagues..." class="form-control">
                </div>
                <div class="col-md-4">
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectAll()">All</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="deselectAll()">None</button>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="selectByCategory('top_tier')">Top Tier</button>
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="selectByCategory('domestic_cup')">Cups</button>
                    </div>
                </div>
            </div>

            <div class="unified-selection-tree">
                {% for region, countries in leagues_by_region.items() %}
                <div class="region-node" data-region="{{ region }}">
                    <div class="node-header">
                        <input type="checkbox" class="region-checkbox" name="selected_regions" value="{{ region }}"
                               onchange="toggleRegion('{{ region }}', this.checked)">
                        <span class="node-label">{{ region }}</span>
                        <span class="badge bg-secondary">
                            {% set total_leagues = 0 %}
                            {% for leagues in countries.values() %}
                                {% set total_leagues = total_leagues + leagues|length %}
                            {% endfor %}
                            {{ total_leagues }}
                        </span>
                        <button type="button" class="btn btn-sm btn-link toggle-btn" onclick="toggleNode(this)">▼</button>
                    </div>
                    
                    <div class="node-children">
                        {% for country, leagues in countries.items() %}
                        <div class="country-node" data-country="{{ country }}" data-region="{{ region }}">
                            <div class="node-header">
                                <input type="checkbox" class="country-checkbox" name="selected_countries" value="{{ country }}"
                                       onchange="toggleCountry('{{ region }}', '{{ country }}', this.checked)">
                                <span class="node-label">{{ country }}</span>
                                <span class="badge bg-info">{{ leagues|length }}</span>
                                <button type="button" class="btn btn-sm btn-link toggle-btn" onclick="toggleNode(this)">▼</button>
                            </div>
                            
                            <div class="node-children">
                                {% for league in leagues %}
                                <div class="league-node" data-league="{{ league.id }}" data-country="{{ country }}" data-region="{{ region }}" data-category="{{ league.category }}">
                                    <div class="node-header">
                                        <input type="checkbox" class="league-checkbox" name="selected_leagues" value="{{ league.id }}"
                                               onchange="updateParentStates('{{ region }}', '{{ country }}')">
                                        <span class="node-label">{{ league.name }}</span>
                                        <span class="badge bg-dark">{{ league.id }}</span>
                                        <span class="category-badge badge bg-{{ 'success' if league.category == 'top_tier' else 'warning' if league.category == 'domestic_cup' else 'secondary' }}">
                                            {{ league.category }}
                                        </span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Advanced Options -->
        <div class="form-section">
            <h3>Advanced Options</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="batch_size">Batch Size:</label>
                        <input type="number" id="batch_size" name="batch_size" value="50" class="form-control">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="progress_file">Progress File:</label>
                        <input type="text" id="progress_file" name="progress_file" value="data_collection_progress.json" class="form-control">
                    </div>
                </div>
            </div>
            
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="keep_progress" id="keep_progress">
                <label class="form-check-label" for="keep_progress">Keep Progress</label>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg">Run Collection</button>
    </form>
</div>

<style>
.unified-selection-tree {
    max-height: 600px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
}

.region-node, .country-node, .league-node {
    margin: 0.25rem 0;
}

.node-header {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    background-color: #f8f9fa;
    border-radius: 0.25rem;
    cursor: pointer;
}

.node-header:hover {
    background-color: #e9ecef;
}

.node-label {
    flex: 1;
    margin: 0 0.5rem;
    font-weight: 500;
}

.node-children {
    margin-left: 2rem;
    padding-left: 0.5rem;
    border-left: 2px solid #dee2e6;
}

.toggle-btn {
    padding: 0;
    width: 20px;
    height: 20px;
    font-size: 0.8rem;
}

.region-node .node-header {
    background-color: #e3f2fd;
}

.country-node .node-header {
    background-color: #f8f9fa;
}

.league-node .node-header {
    background-color: #ffffff;
}

.category-badge {
    font-size: 0.7rem;
    margin-left: 0.5rem;
}

.checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.5rem;
}

.form-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    background-color: #fff;
}
</style>

<script>
// Toggle node expansion
function toggleNode(btn) {
    const children = btn.closest('.node-header').nextElementSibling;
    if (children.style.display === 'none') {
        children.style.display = 'block';
        btn.textContent = '▼';
    } else {
        children.style.display = 'none';
        btn.textContent = '▶';
    }
}

// Toggle entire region
function toggleRegion(region, checked) {
    const checkboxes = document.querySelectorAll(`
        .region-node[data-region="${region}"] .country-checkbox,
        .region-node[data-region="${region}"] .league-checkbox
    `);
    checkboxes.forEach(cb => cb.checked = checked);
    updateRegionState(region);
}

// Toggle entire country
function toggleCountry(region, country, checked) {
    const checkboxes = document.querySelectorAll(`
        .country-node[data-region="${region}"][data-country="${country}"] .league-checkbox
    `);
    checkboxes.forEach(cb => cb.checked = checked);
    updateCountryState(region, country);
    updateRegionState(region);
}

// Update parent states when leagues are selected
function updateParentStates(region, country) {
    updateCountryState(region, country);
    updateRegionState(region);
}

function updateCountryState(region, country) {
    const countryCheckbox = document.querySelector(`
        .country-node[data-region="${region}"][data-country="${country}"] .country-checkbox
    `);
    const leagueCheckboxes = document.querySelectorAll(`
        .country-node[data-region="${region}"][data-country="${country}"] .league-checkbox
    `);
    
    const allChecked = Array.from(leagueCheckboxes).every(cb => cb.checked);
    const someChecked = Array.from(leagueCheckboxes).some(cb => cb.checked);
    
    countryCheckbox.checked = allChecked;
    countryCheckbox.indeterminate = someChecked && !allChecked;
}

function updateRegionState(region) {
    const regionCheckbox = document.querySelector(`
        .region-node[data-region="${region}"] .region-checkbox
    `);
    const countryCheckboxes = document.querySelectorAll(`
        .region-node[data-region="${region}"] .country-checkbox
    `);
    
    const allCountriesChecked = Array.from(countryCheckboxes).every(cb => cb.checked && !cb.indeterminate);
    const someChecked = Array.from(countryCheckboxes).some(cb => cb.checked || cb.indeterminate);
    
    regionCheckbox.checked = allCountriesChecked;
    regionCheckbox.indeterminate = someChecked && !allCountriesChecked;
}

// Quick selection functions
function selectAll() {
    document.querySelectorAll('.region-checkbox, .country-checkbox, .league-checkbox').forEach(cb => {
        cb.checked = true;
    });
    document.querySelectorAll('.region-node').forEach(node => {
        const region = node.getAttribute('data-region');
        updateRegionState(region);
    });
}

function deselectAll() {
    document.querySelectorAll('.region-checkbox, .country-checkbox, .league-checkbox').forEach(cb => {
        cb.checked = false;
        cb.indeterminate = false;
    });
}

function selectByCategory(category) {
    document.querySelectorAll('.league-checkbox').forEach(cb => {
        const leagueCategory = cb.closest('.league-node').getAttribute('data-category');
        cb.checked = (leagueCategory === category);
    });
    // Update all parent states
    document.querySelectorAll('.region-node').forEach(node => {
        const region = node.getAttribute('data-region');
        const countries = node.querySelectorAll('.country-node');
        countries.forEach(countryNode => {
            const country = countryNode.getAttribute('data-country');
            updateCountryState(region, country);
        });
        updateRegionState(region);
    });
}

// Search functionality
document.getElementById('unifiedSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    
    document.querySelectorAll('.region-node, .country-node, .league-node').forEach(node => {
        const text = node.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            node.style.display = 'block';
            // Expand parent nodes
            let parent = node.parentElement;
            while (parent && parent.classList.contains('node-children')) {
                parent.style.display = 'block';
                const header = parent.previousElementSibling;
                if (header && header.classList.contains('node-header')) {
                    const toggleBtn = header.querySelector('.toggle-btn');
                    if (toggleBtn) toggleBtn.textContent = '▼';
                }
                parent = parent.parentElement;
            }
        } else {
            node.style.display = 'none';
        }
    });
});

// Initialize - collapse all nodes by default
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.node-children').forEach(children => {
        children.style.display = 'none';
    });
});
</script>
{% endblock %}